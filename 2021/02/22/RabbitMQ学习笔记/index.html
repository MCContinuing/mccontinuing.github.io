

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>RabbitMQ学习笔记 - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":60,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>MCContinuing's Library</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="RabbitMQ学习笔记">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-02-22 19:33" pubdate>
        February 22, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      13.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      209
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">RabbitMQ学习笔记</h1>
            
            <div class="markdown-body">
              <h1 id="RabbitMQ简介"><a href="#RabbitMQ简介" class="headerlink" title="RabbitMQ简介"></a>RabbitMQ简介</h1><p>RabbitMQ是由erlang语言开发，基于AMQP（Advanced Message Queue 高级消息队列协议）协议实现的消息队列，它是一种应用程序之间的通信方法，消息队列在分布式系统开发中应用非常广泛。</p>
<p>RabbitMQ官方地址：<a target="_blank" rel="noopener" href="http://www.rabbitmq.com/">http://www.rabbitmq.com/</a></p>
<p>RabbitMQ提供了6种模式：</p>
<ul>
<li>简单模式</li>
<li>work模式</li>
<li>Publish/Subscribe发布与订阅模式</li>
<li>Routing路由模式</li>
<li>Topics主题模式</li>
<li>RPC远程调用模式（远程调用，不太算MQ；暂不作介绍）；</li>
</ul>
<p>官网对应模式介绍：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1555988678324.png" srcset="/img/loading.gif" alt="1555988678324"></p>
<h1 id="管控台添加用户及虚拟机"><a href="#管控台添加用户及虚拟机" class="headerlink" title="管控台添加用户及虚拟机"></a>管控台添加用户及虚拟机</h1><p>添加用户并设置admin权限</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223213219690.png" srcset="/img/loading.gif" alt="image-20210223213219690"></p>
<p>添加虚拟机</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223213350944.png" srcset="/img/loading.gif" alt="image-20210223213350944"></p>
<p>点击此虚拟机，设置用户访问此虚拟机</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223213749299.png" srcset="/img/loading.gif" alt="image-20210223213749299"></p>
<p>退出重新登陆新设置用户</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223213912977.png" srcset="/img/loading.gif" alt="image-20210223213912977"></p>
<h1 id="六种工作模式的实现"><a href="#六种工作模式的实现" class="headerlink" title="六种工作模式的实现"></a>六种工作模式的实现</h1><p>RabbitMQ基础架构图</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223215519211.png" srcset="/img/loading.gif" alt="image-20210223215519211"></p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223215113592.png" srcset="/img/loading.gif" alt="image-20210223215113592"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--rabbitmq java 客户端--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.rabbitmq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>amqp-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在所有pom中都要加入上述依赖</p>
<h2 id="简单模式"><a href="#简单模式" class="headerlink" title="简单模式"></a>简单模式</h2><p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223215250866.png" srcset="/img/loading.gif" alt="image-20210223215250866"></p>
<p><strong>producer_Helloworld.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.producer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发送消息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer_HelloWorld</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br>        <span class="hljs-comment">//5. 创建队列Queue</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. durable:是否持久化，当mq重启之后，还在</span><br><span class="hljs-comment">            3. exclusive：</span><br><span class="hljs-comment">                * 是否独占。只能有一个消费者监听这队列</span><br><span class="hljs-comment">                * 当Connection关闭时，是否删除队列</span><br><span class="hljs-comment">                *</span><br><span class="hljs-comment">            4. autoDelete:是否自动删除。当没有Consumer时，自动删除掉</span><br><span class="hljs-comment">            5. arguments：参数。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">//如果没有一个名字叫hello_world的队列，则会创建该队列，如果有则不会创建</span><br>        channel.queueDeclare(<span class="hljs-string">&quot;hello_world&quot;</span>,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        basicPublish(String exchange, String routingKey, BasicProperties props, byte[] body)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. exchange：交换机名称。简单模式下交换机会使用默认的 &quot;&quot;</span><br><span class="hljs-comment">            2. routingKey：路由名称</span><br><span class="hljs-comment">            3. props：配置信息</span><br><span class="hljs-comment">            4. body：发送消息数据</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br><br>        String body = <span class="hljs-string">&quot;hello rabbitmq~~~&quot;</span>;<br><br>        <span class="hljs-comment">//6. 发送消息</span><br>        channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;hello_world&quot;</span>,<span class="hljs-keyword">null</span>,body.getBytes());<br><br><br>        <span class="hljs-comment">//7.释放资源</span><br>      channel.close();<br>      connection.close();<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>运行生产者</p>
<p><strong>Consumer_Helloworld.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer_HelloWorld</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br>        <span class="hljs-comment">//5. 创建队列Queue</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. durable:是否持久化，当mq重启之后，还在</span><br><span class="hljs-comment">            3. exclusive：</span><br><span class="hljs-comment">                * 是否独占。只能有一个消费者监听这队列</span><br><span class="hljs-comment">                * 当Connection关闭时，是否删除队列</span><br><span class="hljs-comment">                *</span><br><span class="hljs-comment">            4. autoDelete:是否自动删除。当没有Consumer时，自动删除掉</span><br><span class="hljs-comment">            5. arguments：参数。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">//如果没有一个名字叫hello_world的队列，则会创建该队列，如果有则不会创建</span><br>        channel.queueDeclare(<span class="hljs-string">&quot;hello_world&quot;</span>,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        basicConsume(String queue, boolean autoAck, Consumer callback)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. autoAck：是否自动确认</span><br><span class="hljs-comment">            3. callback：回调对象</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// 接收消息</span><br>        Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">                回调方法，当收到消息后，会自动执行该方法</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                1. consumerTag：标识</span><br><span class="hljs-comment">                2. envelope：获取一些信息，交换机，路由key...</span><br><span class="hljs-comment">                3. properties:配置信息</span><br><span class="hljs-comment">                4. body：数据</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                System.out.println(<span class="hljs-string">&quot;consumerTag：&quot;</span>+consumerTag);<br>                System.out.println(<span class="hljs-string">&quot;Exchange：&quot;</span>+envelope.getExchange());<br>                System.out.println(<span class="hljs-string">&quot;RoutingKey：&quot;</span>+envelope.getRoutingKey());<br>                System.out.println(<span class="hljs-string">&quot;properties：&quot;</span>+properties);<br>                System.out.println(<span class="hljs-string">&quot;body：&quot;</span>+<span class="hljs-keyword">new</span> String(body));<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(<span class="hljs-string">&quot;hello_world&quot;</span>,<span class="hljs-keyword">true</span>,consumer);<br><br><br>        <span class="hljs-comment">//关闭资源？不要</span><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行消费者</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223214624036.png" srcset="/img/loading.gif" alt="image-20210223214624036"></p>
<p>同时可以看见控制台的变化</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223214658662.png" srcset="/img/loading.gif" alt="image-20210223214658662"></p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223214722175.png" srcset="/img/loading.gif" alt="image-20210223214722175"></p>
<h2 id="WorkQueue工作队列模式"><a href="#WorkQueue工作队列模式" class="headerlink" title="WorkQueue工作队列模式"></a><strong>WorkQueue工作队列模式</strong></h2><p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223220853733.png" srcset="/img/loading.gif" alt="image-20210223220853733"></p>
<p>同简单模式代码设置两个一样的消费者即可</p>
<p><strong>Producer_WorkQueues.java</strong></p>
<p>生产者一次性生产多个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.producer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发送消息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer_WorkQueues</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;172.16.98.133&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;heima&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;heima&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br>        <span class="hljs-comment">//5. 创建队列Queue</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. durable:是否持久化，当mq重启之后，还在</span><br><span class="hljs-comment">            3. exclusive：</span><br><span class="hljs-comment">                * 是否独占。只能有一个消费者监听这队列</span><br><span class="hljs-comment">                * 当Connection关闭时，是否删除队列</span><br><span class="hljs-comment">                *</span><br><span class="hljs-comment">            4. autoDelete:是否自动删除。当没有Consumer时，自动删除掉</span><br><span class="hljs-comment">            5. arguments：参数。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">//如果没有一个名字叫hello_world的队列，则会创建该队列，如果有则不会创建</span><br>        channel.queueDeclare(<span class="hljs-string">&quot;work_queues&quot;</span>,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        basicPublish(String exchange, String routingKey, BasicProperties props, byte[] body)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. exchange：交换机名称。简单模式下交换机会使用默认的 &quot;&quot;</span><br><span class="hljs-comment">            2. routingKey：路由名称</span><br><span class="hljs-comment">            3. props：配置信息</span><br><span class="hljs-comment">            4. body：发送消息数据</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++) &#123;<br>            String body = i+<span class="hljs-string">&quot;hello rabbitmq~~~&quot;</span>;<br><br>            <span class="hljs-comment">//6. 发送消息</span><br>            channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;work_queues&quot;</span>,<span class="hljs-keyword">null</span>,body.getBytes());<br>        &#125;<br><br>        <span class="hljs-comment">//7.释放资源</span><br>      channel.close();<br>      connection.close();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行生产者</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223221340543.png" srcset="/img/loading.gif" alt="image-20210223221340543"></p>
<p><strong>Consumer_WorkQueues1.java</strong></p>
<p><strong>Consumer_WorkQueues2.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer_WorkQueues1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br>        <span class="hljs-comment">//5. 创建队列Queue</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. durable:是否持久化，当mq重启之后，还在</span><br><span class="hljs-comment">            3. exclusive：</span><br><span class="hljs-comment">                * 是否独占。只能有一个消费者监听这队列</span><br><span class="hljs-comment">                * 当Connection关闭时，是否删除队列</span><br><span class="hljs-comment">                *</span><br><span class="hljs-comment">            4. autoDelete:是否自动删除。当没有Consumer时，自动删除掉</span><br><span class="hljs-comment">            5. arguments：参数。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">//如果没有一个名字叫hello_world的队列，则会创建该队列，如果有则不会创建</span><br>        channel.queueDeclare(<span class="hljs-string">&quot;work_queues&quot;</span>,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        basicConsume(String queue, boolean autoAck, Consumer callback)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. autoAck：是否自动确认</span><br><span class="hljs-comment">            3. callback：回调对象</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// 接收消息</span><br>        Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">                回调方法，当收到消息后，会自动执行该方法</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                1. consumerTag：标识</span><br><span class="hljs-comment">                2. envelope：获取一些信息，交换机，路由key...</span><br><span class="hljs-comment">                3. properties:配置信息</span><br><span class="hljs-comment">                4. body：数据</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>              <span class="hljs-comment">/*  System.out.println(&quot;consumerTag：&quot;+consumerTag);</span><br><span class="hljs-comment">                System.out.println(&quot;Exchange：&quot;+envelope.getExchange());</span><br><span class="hljs-comment">                System.out.println(&quot;RoutingKey：&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">                System.out.println(&quot;properties：&quot;+properties);*/</span><br>                System.out.println(<span class="hljs-string">&quot;body：&quot;</span>+<span class="hljs-keyword">new</span> String(body));<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(<span class="hljs-string">&quot;work_queues&quot;</span>,<span class="hljs-keyword">true</span>,consumer);<br><br><br>        <span class="hljs-comment">//关闭资源？不要</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>同时开启两个消费者，消费者属于竞争关系</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210223221747421.png" srcset="/img/loading.gif" alt="image-20210223221747421"></p>
<h2 id="Pub-Sub订阅模式"><a href="#Pub-Sub订阅模式" class="headerlink" title="Pub/Sub订阅模式"></a>Pub/Sub订阅模式</h2><p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224150909741.png" srcset="/img/loading.gif" alt="image-20210224150909741"></p>
<p><strong>Producer_PubSub.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.producer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发送消息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer_PubSub</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br>       <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span><br><span class="hljs-comment">       参数：</span><br><span class="hljs-comment">        1. exchange:交换机名称</span><br><span class="hljs-comment">        2. type:交换机类型</span><br><span class="hljs-comment">            DIRECT(&quot;direct&quot;),：定向</span><br><span class="hljs-comment">            FANOUT(&quot;fanout&quot;),：扇形（广播），发送消息到每一个与之绑定队列。</span><br><span class="hljs-comment">            TOPIC(&quot;topic&quot;),通配符的方式</span><br><span class="hljs-comment">            HEADERS(&quot;headers&quot;);参数匹配</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        3. durable:是否持久化</span><br><span class="hljs-comment">        4. autoDelete:自动删除</span><br><span class="hljs-comment">        5. internal：内部使用。 一般false</span><br><span class="hljs-comment">        6. arguments：参数</span><br><span class="hljs-comment">        */</span><br><br>       String exchangeName = <span class="hljs-string">&quot;test_fanout&quot;</span>;<br>        <span class="hljs-comment">//5. 创建交换机</span><br>        channel.exchangeDeclare(exchangeName, BuiltinExchangeType.FANOUT,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>        <span class="hljs-comment">//6. 创建队列</span><br>        String queue1Name = <span class="hljs-string">&quot;test_fanout_queue1&quot;</span>;<br>        String queue2Name = <span class="hljs-string">&quot;test_fanout_queue2&quot;</span>;<br>        channel.queueDeclare(queue1Name,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>        channel.queueDeclare(queue2Name,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>        <span class="hljs-comment">//7. 绑定队列和交换机</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        queueBind(String queue, String exchange, String routingKey)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. exchange：交换机名称</span><br><span class="hljs-comment">            3. routingKey：路由键，绑定规则</span><br><span class="hljs-comment">                如果交换机的类型为fanout ，routingKey设置为&quot;&quot;</span><br><span class="hljs-comment">         */</span><br>        channel.queueBind(queue1Name,exchangeName,<span class="hljs-string">&quot;&quot;</span>);<br>        channel.queueBind(queue2Name,exchangeName,<span class="hljs-string">&quot;&quot;</span>);<br><br>        String body = <span class="hljs-string">&quot;日志信息：张三调用了findAll方法...日志级别：info...&quot;</span>;<br>        <span class="hljs-comment">//8. 发送消息</span><br>        channel.basicPublish(exchangeName,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-keyword">null</span>,body.getBytes());<br><br>        <span class="hljs-comment">//9. 释放资源</span><br>        channel.close();<br>        connection.close();<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>Consumer_PubSub1</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer_PubSub1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br><br><br>        String queue1Name = <span class="hljs-string">&quot;test_fanout_queue1&quot;</span>;<br>        String queue2Name = <span class="hljs-string">&quot;test_fanout_queue2&quot;</span>;<br><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        basicConsume(String queue, boolean autoAck, Consumer callback)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. autoAck：是否自动确认</span><br><span class="hljs-comment">            3. callback：回调对象</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// 接收消息</span><br>        Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">                回调方法，当收到消息后，会自动执行该方法</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                1. consumerTag：标识</span><br><span class="hljs-comment">                2. envelope：获取一些信息，交换机，路由key...</span><br><span class="hljs-comment">                3. properties:配置信息</span><br><span class="hljs-comment">                4. body：数据</span><br><span class="hljs-comment">a</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>              <span class="hljs-comment">/*  System.out.println(&quot;consumerTag：&quot;+consumerTag);</span><br><span class="hljs-comment">                System.out.println(&quot;Exchange：&quot;+envelope.getExchange());</span><br><span class="hljs-comment">                System.out.println(&quot;RoutingKey：&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">                System.out.println(&quot;properties：&quot;+properties);*/</span><br>                System.out.println(<span class="hljs-string">&quot;body：&quot;</span>+<span class="hljs-keyword">new</span> String(body));<br>                System.out.println(<span class="hljs-string">&quot;将日志信息打印到控制台.....&quot;</span>);<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(queue1Name,<span class="hljs-keyword">true</span>,consumer);<br><br><br>        <span class="hljs-comment">//关闭资源？不要</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>Consumer_PubSub2</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer_PubSub2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br><br><br>        String queue1Name = <span class="hljs-string">&quot;test_fanout_queue1&quot;</span>;<br>        String queue2Name = <span class="hljs-string">&quot;test_fanout_queue2&quot;</span>;<br><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        basicConsume(String queue, boolean autoAck, Consumer callback)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. autoAck：是否自动确认</span><br><span class="hljs-comment">            3. callback：回调对象</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// 接收消息</span><br>        Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">                回调方法，当收到消息后，会自动执行该方法</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                1. consumerTag：标识</span><br><span class="hljs-comment">                2. envelope：获取一些信息，交换机，路由key...</span><br><span class="hljs-comment">                3. properties:配置信息</span><br><span class="hljs-comment">                4. body：数据</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>              <span class="hljs-comment">/*  System.out.println(&quot;consumerTag：&quot;+consumerTag);</span><br><span class="hljs-comment">                System.out.println(&quot;Exchange：&quot;+envelope.getExchange());</span><br><span class="hljs-comment">                System.out.println(&quot;RoutingKey：&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">                System.out.println(&quot;properties：&quot;+properties);*/</span><br>                System.out.println(<span class="hljs-string">&quot;body：&quot;</span>+<span class="hljs-keyword">new</span> String(body));<br>                System.out.println(<span class="hljs-string">&quot;将日志信息保存数据库.....&quot;</span>);<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(queue2Name,<span class="hljs-keyword">true</span>,consumer);<br><br><br>        <span class="hljs-comment">//关闭资源？不要</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="Routing路由模式"><a href="#Routing路由模式" class="headerlink" title="Routing路由模式"></a>Routing路由模式</h2><p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224151059609.png" srcset="/img/loading.gif" alt="image-20210224151059609"></p>
<p><strong>Producer_Routing.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer_PubSub2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br><br><br>        String queue1Name = <span class="hljs-string">&quot;test_fanout_queue1&quot;</span>;<br>        String queue2Name = <span class="hljs-string">&quot;test_fanout_queue2&quot;</span>;<br><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        basicConsume(String queue, boolean autoAck, Consumer callback)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. autoAck：是否自动确认</span><br><span class="hljs-comment">            3. callback：回调对象</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// 接收消息</span><br>        Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">                回调方法，当收到消息后，会自动执行该方法</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                1. consumerTag：标识</span><br><span class="hljs-comment">                2. envelope：获取一些信息，交换机，路由key...</span><br><span class="hljs-comment">                3. properties:配置信息</span><br><span class="hljs-comment">                4. body：数据</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>              <span class="hljs-comment">/*  System.out.println(&quot;consumerTag：&quot;+consumerTag);</span><br><span class="hljs-comment">                System.out.println(&quot;Exchange：&quot;+envelope.getExchange());</span><br><span class="hljs-comment">                System.out.println(&quot;RoutingKey：&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">                System.out.println(&quot;properties：&quot;+properties);*/</span><br>                System.out.println(<span class="hljs-string">&quot;body：&quot;</span>+<span class="hljs-keyword">new</span> String(body));<br>                System.out.println(<span class="hljs-string">&quot;将日志信息保存数据库.....&quot;</span>);<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(queue2Name,<span class="hljs-keyword">true</span>,consumer);<br><br><br>        <span class="hljs-comment">//关闭资源？不要</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>Consumer_Routing1.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer_Routing1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br><br><br>        String queue1Name = <span class="hljs-string">&quot;test_direct_queue1&quot;</span>;<br>        String queue2Name = <span class="hljs-string">&quot;test_direct_queue2&quot;</span>;<br><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        basicConsume(String queue, boolean autoAck, Consumer callback)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. autoAck：是否自动确认</span><br><span class="hljs-comment">            3. callback：回调对象</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// 接收消息</span><br>        Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">                回调方法，当收到消息后，会自动执行该方法</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                1. consumerTag：标识</span><br><span class="hljs-comment">                2. envelope：获取一些信息，交换机，路由key...</span><br><span class="hljs-comment">                3. properties:配置信息</span><br><span class="hljs-comment">                4. body：数据</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>              <span class="hljs-comment">/*  System.out.println(&quot;consumerTag：&quot;+consumerTag);</span><br><span class="hljs-comment">                System.out.println(&quot;Exchange：&quot;+envelope.getExchange());</span><br><span class="hljs-comment">                System.out.println(&quot;RoutingKey：&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">                System.out.println(&quot;properties：&quot;+properties);*/</span><br>                System.out.println(<span class="hljs-string">&quot;body：&quot;</span>+<span class="hljs-keyword">new</span> String(body));<br>                System.out.println(<span class="hljs-string">&quot;将日志信息打印到控制台.....&quot;</span>);<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(queue2Name,<span class="hljs-keyword">true</span>,consumer);<br><br><br>        <span class="hljs-comment">//关闭资源？不要</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>Consumer_Routing2.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer_Routing2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br><br><br>        String queue1Name = <span class="hljs-string">&quot;test_direct_queue1&quot;</span>;<br>        String queue2Name = <span class="hljs-string">&quot;test_direct_queue2&quot;</span>;<br><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        basicConsume(String queue, boolean autoAck, Consumer callback)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. autoAck：是否自动确认</span><br><span class="hljs-comment">            3. callback：回调对象</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// 接收消息</span><br>        Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">                回调方法，当收到消息后，会自动执行该方法</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                1. consumerTag：标识</span><br><span class="hljs-comment">                2. envelope：获取一些信息，交换机，路由key...</span><br><span class="hljs-comment">                3. properties:配置信息</span><br><span class="hljs-comment">                4. body：数据</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>              <span class="hljs-comment">/*  System.out.println(&quot;consumerTag：&quot;+consumerTag);</span><br><span class="hljs-comment">                System.out.println(&quot;Exchange：&quot;+envelope.getExchange());</span><br><span class="hljs-comment">                System.out.println(&quot;RoutingKey：&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">                System.out.println(&quot;properties：&quot;+properties);*/</span><br>                System.out.println(<span class="hljs-string">&quot;body：&quot;</span>+<span class="hljs-keyword">new</span> String(body));<br>                System.out.println(<span class="hljs-string">&quot;将日志信息存储到数据库.....&quot;</span>);<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(queue1Name,<span class="hljs-keyword">true</span>,consumer);<br><br><br>        <span class="hljs-comment">//关闭资源？不要</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<h2 id="Topic通配符模式"><a href="#Topic通配符模式" class="headerlink" title="Topic通配符模式"></a>Topic通配符模式</h2><p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224151136431.png" srcset="/img/loading.gif" alt="image-20210224151136431"></p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224151212740.png" srcset="/img/loading.gif" alt="image-20210224151212740"></p>
<p><strong>Producer_Topic.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.producer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Connection;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.ConnectionFactory;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发送消息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer_Topics</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br>       <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span><br><span class="hljs-comment">       参数：</span><br><span class="hljs-comment">        1. exchange:交换机名称</span><br><span class="hljs-comment">        2. type:交换机类型</span><br><span class="hljs-comment">            DIRECT(&quot;direct&quot;),：定向</span><br><span class="hljs-comment">            FANOUT(&quot;fanout&quot;),：扇形（广播），发送消息到每一个与之绑定队列。</span><br><span class="hljs-comment">            TOPIC(&quot;topic&quot;),通配符的方式</span><br><span class="hljs-comment">            HEADERS(&quot;headers&quot;);参数匹配</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        3. durable:是否持久化</span><br><span class="hljs-comment">        4. autoDelete:自动删除</span><br><span class="hljs-comment">        5. internal：内部使用。 一般false</span><br><span class="hljs-comment">        6. arguments：参数</span><br><span class="hljs-comment">        */</span><br><br>       String exchangeName = <span class="hljs-string">&quot;test_topic&quot;</span>;<br>        <span class="hljs-comment">//5. 创建交换机</span><br>        channel.exchangeDeclare(exchangeName, BuiltinExchangeType.TOPIC,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>        <span class="hljs-comment">//6. 创建队列</span><br>        String queue1Name = <span class="hljs-string">&quot;test_topic_queue1&quot;</span>;<br>        String queue2Name = <span class="hljs-string">&quot;test_topic_queue2&quot;</span>;<br>        channel.queueDeclare(queue1Name,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>        channel.queueDeclare(queue2Name,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>        <span class="hljs-comment">//7. 绑定队列和交换机</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        queueBind(String queue, String exchange, String routingKey)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. exchange：交换机名称</span><br><span class="hljs-comment">            3. routingKey：路由键，绑定规则</span><br><span class="hljs-comment">                如果交换机的类型为fanout ，routingKey设置为&quot;&quot;</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">// routing key  系统的名称.日志的级别。</span><br>        <span class="hljs-comment">//=需求： 所有error级别的日志存入数据库，所有order系统的日志存入数据库</span><br>        channel.queueBind(queue1Name,exchangeName,<span class="hljs-string">&quot;#.error&quot;</span>);<br>        channel.queueBind(queue1Name,exchangeName,<span class="hljs-string">&quot;order.*&quot;</span>);<br>        channel.queueBind(queue2Name,exchangeName,<span class="hljs-string">&quot;*.*&quot;</span>);<br><br>        String body = <span class="hljs-string">&quot;日志信息：张三调用了findAll方法...日志级别：info...&quot;</span>;<br>        <span class="hljs-comment">//8. 发送消息</span><br>        channel.basicPublish(exchangeName,<span class="hljs-string">&quot;goods.error&quot;</span>,<span class="hljs-keyword">null</span>,body.getBytes());<br><br>        <span class="hljs-comment">//9. 释放资源</span><br>        channel.close();<br>        connection.close();<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>Consumer_Topic1.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer_Topic1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br><br><br>        String queue1Name = <span class="hljs-string">&quot;test_topic_queue1&quot;</span>;<br>        String queue2Name = <span class="hljs-string">&quot;test_topic_queue2&quot;</span>;<br><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        basicConsume(String queue, boolean autoAck, Consumer callback)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. autoAck：是否自动确认</span><br><span class="hljs-comment">            3. callback：回调对象</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// 接收消息</span><br>        Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">                回调方法，当收到消息后，会自动执行该方法</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                1. consumerTag：标识</span><br><span class="hljs-comment">                2. envelope：获取一些信息，交换机，路由key...</span><br><span class="hljs-comment">                3. properties:配置信息</span><br><span class="hljs-comment">                4. body：数据</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>              <span class="hljs-comment">/*  System.out.println(&quot;consumerTag：&quot;+consumerTag);</span><br><span class="hljs-comment">                System.out.println(&quot;Exchange：&quot;+envelope.getExchange());</span><br><span class="hljs-comment">                System.out.println(&quot;RoutingKey：&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">                System.out.println(&quot;properties：&quot;+properties);*/</span><br>                System.out.println(<span class="hljs-string">&quot;body：&quot;</span>+<span class="hljs-keyword">new</span> String(body));<br>                System.out.println(<span class="hljs-string">&quot;将日志信息存入数据库.......&quot;</span>);<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(queue1Name,<span class="hljs-keyword">true</span>,consumer);<br><br><br>        <span class="hljs-comment">//关闭资源？不要</span><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>Consumer_Topic.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.consumer;<br><br><span class="hljs-keyword">import</span> com.rabbitmq.client.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeoutException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer_Topic2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//1.创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//2. 设置参数</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.91.130&quot;</span>);<span class="hljs-comment">//ip  默认值 localhost</span><br>        factory.setPort(<span class="hljs-number">5672</span>); <span class="hljs-comment">//端口  默认值 5672</span><br>        factory.setVirtualHost(<span class="hljs-string">&quot;/itcast&quot;</span>);<span class="hljs-comment">//虚拟机 默认值/</span><br>        factory.setUsername(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//用户名 默认 guest</span><br>        factory.setPassword(<span class="hljs-string">&quot;mochen&quot;</span>);<span class="hljs-comment">//密码 默认值 guest</span><br>        <span class="hljs-comment">//3. 创建连接 Connection</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//4. 创建Channel</span><br>        Channel channel = connection.createChannel();<br><br><br>        String queue1Name = <span class="hljs-string">&quot;test_topic_queue1&quot;</span>;<br>        String queue2Name = <span class="hljs-string">&quot;test_topic_queue2&quot;</span>;<br><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        basicConsume(String queue, boolean autoAck, Consumer callback)</span><br><span class="hljs-comment">        参数：</span><br><span class="hljs-comment">            1. queue：队列名称</span><br><span class="hljs-comment">            2. autoAck：是否自动确认</span><br><span class="hljs-comment">            3. callback：回调对象</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// 接收消息</span><br>        Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">                回调方法，当收到消息后，会自动执行该方法</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                1. consumerTag：标识</span><br><span class="hljs-comment">                2. envelope：获取一些信息，交换机，路由key...</span><br><span class="hljs-comment">                3. properties:配置信息</span><br><span class="hljs-comment">                4. body：数据</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>              <span class="hljs-comment">/*  System.out.println(&quot;consumerTag：&quot;+consumerTag);</span><br><span class="hljs-comment">                System.out.println(&quot;Exchange：&quot;+envelope.getExchange());</span><br><span class="hljs-comment">                System.out.println(&quot;RoutingKey：&quot;+envelope.getRoutingKey());</span><br><span class="hljs-comment">                System.out.println(&quot;properties：&quot;+properties);*/</span><br>                System.out.println(<span class="hljs-string">&quot;body：&quot;</span>+<span class="hljs-keyword">new</span> String(body));<br>                System.out.println(<span class="hljs-string">&quot;将日志信息打印控制台.......&quot;</span>);<br>            &#125;<br>        &#125;;<br>        channel.basicConsume(queue2Name,<span class="hljs-keyword">true</span>,consumer);<br><br><br>        <span class="hljs-comment">//关闭资源？不要</span><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="SSpring整合RabbbitMQ"><a href="#SSpring整合RabbbitMQ" class="headerlink" title="SSpring整合RabbbitMQ"></a>SSpring整合RabbbitMQ</h1><p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224160452851.png" srcset="/img/loading.gif" alt="image-20210224160452851"></p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224160949065.png" srcset="/img/loading.gif" alt="image-20210224160949065"></p>
<p>所有pom添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-rabbitmq-producers<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.amqp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-rabbit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.8.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h2 id="搭建Producers工程"><a href="#搭建Producers工程" class="headerlink" title="搭建Producers工程"></a><strong>搭建Producers工程</strong></h2><h3 id="配置整合"><a href="#配置整合" class="headerlink" title="配置整合"></a>配置整合</h3><p><strong>rabbitmq.properties</strong>:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">rabbitmq.host</span>=<span class="hljs-string">192.168.91.130</span><br><span class="hljs-meta">rabbitmq.port</span>=<span class="hljs-string">5672</span><br><span class="hljs-meta">rabbitmq.username</span>=<span class="hljs-string">heima</span><br><span class="hljs-meta">rabbitmq.password</span>=<span class="hljs-string">heima</span><br><span class="hljs-meta">rabbitmq.virtual-host</span>=<span class="hljs-string">/itcast</span><br></code></pre></td></tr></table></figure>

<p><strong>spring-rabbitmq-producer.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:rabbit</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/context</span></span><br><span class="hljs-tag"><span class="hljs-string">       https://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/rabbit</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--加载配置文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;classpath:rabbitmq.properties&quot;</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:connection-factory</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">username</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">virtual-host</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!--定义管理交换机、队列--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:admin</span> <span class="hljs-attr">connection-factory</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!--定义持久化队列，不存在则自动创建；不绑定到交换机则绑定到默认交换机</span><br><span class="hljs-comment">    默认交换机类型为direct，名字为：&quot;&quot;，路由键为队列的名称</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">        id：bean的名称</span><br><span class="hljs-comment">        name：queue的名称</span><br><span class="hljs-comment">        auto-declare:自动创建</span><br><span class="hljs-comment">        auto-delete:自动删除。 最后一个消费者和该队列断开连接后，自动删除队列</span><br><span class="hljs-comment">        exclusive:是否独占</span><br><span class="hljs-comment">        durable：是否持久化</span><br><span class="hljs-comment">    --&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;spring_queue&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;spring_queue&quot;</span>    <span class="hljs-attr">auto-declare</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~广播；所有队列都能收到消息~~~~~~~~~~~~~~~~~~~~~~~~~~~~ --&gt;</span><br>    <span class="hljs-comment">&lt;!--定义广播交换机中的持久化队列，不存在则自动创建--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;spring_fanout_queue_1&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;spring_fanout_queue_1&quot;</span> <span class="hljs-attr">auto-declare</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!--定义广播交换机中的持久化队列，不存在则自动创建--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;spring_fanout_queue_2&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;spring_fanout_queue_2&quot;</span> <span class="hljs-attr">auto-declare</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!--定义广播类型交换机；并绑定上述两个队列--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:fanout-exchange</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;spring_fanout_exchange&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;spring_fanout_exchange&quot;</span>  <span class="hljs-attr">auto-declare</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:binding</span>  <span class="hljs-attr">queue</span>=<span class="hljs-string">&quot;spring_fanout_queue_1&quot;</span>  /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:binding</span> <span class="hljs-attr">queue</span>=<span class="hljs-string">&quot;spring_fanout_queue_2&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:fanout-exchange</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--&lt;rabbit:direct-exchange name=&quot;aa&quot; &gt;</span><br><span class="hljs-comment">        &lt;rabbit:bindings&gt;</span><br><span class="hljs-comment">            &amp;lt;!&amp;ndash;direct 类型的交换机绑定队列  key ：路由key  queue：队列名称&amp;ndash;&amp;gt;</span><br><span class="hljs-comment">            &lt;rabbit:binding queue=&quot;spring_queue&quot; key=&quot;xxx&quot;&gt;&lt;/rabbit:binding&gt;</span><br><span class="hljs-comment">        &lt;/rabbit:bindings&gt;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    &lt;/rabbit:direct-exchange&gt;--&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~通配符；*匹配一个单词，#匹配多个单词 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~ --&gt;</span><br>    <span class="hljs-comment">&lt;!--定义广播交换机中的持久化队列，不存在则自动创建--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;spring_topic_queue_star&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;spring_topic_queue_star&quot;</span>  <span class="hljs-attr">auto-declare</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!--定义广播交换机中的持久化队列，不存在则自动创建--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;spring_topic_queue_well&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;spring_topic_queue_well&quot;</span> <span class="hljs-attr">auto-declare</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!--定义广播交换机中的持久化队列，不存在则自动创建--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;spring_topic_queue_well2&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;spring_topic_queue_well2&quot;</span> <span class="hljs-attr">auto-declare</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:topic-exchange</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;spring_topic_exchange&quot;</span>  <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;spring_topic_exchange&quot;</span> <span class="hljs-attr">auto-declare</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:binding</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;heima.*&quot;</span>  <span class="hljs-attr">queue</span>=<span class="hljs-string">&quot;spring_topic_queue_star&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:binding</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;heima.#&quot;</span> <span class="hljs-attr">queue</span>=<span class="hljs-string">&quot;spring_topic_queue_well&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:binding</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;itcast.#&quot;</span> <span class="hljs-attr">queue</span>=<span class="hljs-string">&quot;spring_topic_queue_well2&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:topic-exchange</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:template</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;rabbitTemplate&quot;</span> <span class="hljs-attr">connection-factory</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="发送消息"><a href="#发送消息" class="headerlink" title="发送消息"></a>发送消息</h3><p><strong>ProducerTest.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima;<br><br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.test.context.ContextConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;<br><br><span class="hljs-meta">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="hljs-meta">@ContextConfiguration(locations = &quot;classpath:spring/spring-rabbitmq.xml&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducerTest</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 只发队列消息</span><br><span class="hljs-comment">     * 默认交换机类型为 direct</span><br><span class="hljs-comment">     * 交换机的名称为空，路由键为队列的名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queueTest</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//路由键与队列同名</span><br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_queue&quot;</span>, <span class="hljs-string">&quot;只发队列spring_queue的消息。&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发送广播</span><br><span class="hljs-comment">     * 交换机类型为 fanout</span><br><span class="hljs-comment">     * 绑定到该交换机的所有队列都能够收到消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">fanoutTest</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：交换机名称</span><br><span class="hljs-comment">         * 参数2：路由键名（广播设置为空）</span><br><span class="hljs-comment">         * 参数3：发送的消息内容</span><br><span class="hljs-comment">         */</span><br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_fanout_exchange&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;发送到spring_fanout_exchange交换机的广播消息&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通配符</span><br><span class="hljs-comment">     * 交换机类型为 topic</span><br><span class="hljs-comment">     * 匹配路由键的通配符，*表示一个单词，#表示多个单词</span><br><span class="hljs-comment">     * 绑定到该交换机的匹配队列能够收到对应消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">topicTest</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：交换机名称</span><br><span class="hljs-comment">         * 参数2：路由键名</span><br><span class="hljs-comment">         * 参数3：发送的消息内容</span><br><span class="hljs-comment">         */</span><br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_topic_exchange&quot;</span>, <span class="hljs-string">&quot;heima.bj&quot;</span>, <span class="hljs-string">&quot;发送到spring_topic_exchange交换机heima.bj的消息&quot;</span>);<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_topic_exchange&quot;</span>, <span class="hljs-string">&quot;heima.bj.1&quot;</span>, <span class="hljs-string">&quot;发送到spring_topic_exchange交换机heima.bj.1的消息&quot;</span>);<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_topic_exchange&quot;</span>, <span class="hljs-string">&quot;heima.bj.2&quot;</span>, <span class="hljs-string">&quot;发送到spring_topic_exchange交换机heima.bj.2的消息&quot;</span>);<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;spring_topic_exchange&quot;</span>, <span class="hljs-string">&quot;itcast.cn&quot;</span>, <span class="hljs-string">&quot;发送到spring_topic_exchange交换机itcast.cn的消息&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="搭建consumers工程"><a href="#搭建consumers工程" class="headerlink" title="搭建consumers工程:"></a><strong>搭建consumers工程:</strong></h2><h3 id="配置整合-1"><a href="#配置整合-1" class="headerlink" title="配置整合"></a>配置整合</h3><ol>
<li>创建<code>spring-rabbitmq-consumer\src\main\resources\properties\rabbitmq.properties</code>连接参数等配置文件；</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">rabbitmq.host</span>=<span class="hljs-string">192.168.91.130</span><br><span class="hljs-meta">rabbitmq.port</span>=<span class="hljs-string">5672</span><br><span class="hljs-meta">rabbitmq.username</span>=<span class="hljs-string">heima</span><br><span class="hljs-meta">rabbitmq.password</span>=<span class="hljs-string">heima</span><br><span class="hljs-meta">rabbitmq.virtual-host</span>=<span class="hljs-string">/itcast</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>创建 <code>spring-rabbitmq-consumer\src\main\resources\spring\spring-rabbitmq.xml</code> 整合配置文件；</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:rabbit</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/context</span></span><br><span class="hljs-tag"><span class="hljs-string">       https://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/rabbit</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--加载配置文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;classpath:properties/rabbitmq.properties&quot;</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:connection-factory</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">username</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">virtual-host</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;springQueueListener&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.itheima.rabbitmq.listener.SpringQueueListener&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;fanoutListener1&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.itheima.rabbitmq.listener.FanoutListener1&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;fanoutListener2&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.itheima.rabbitmq.listener.FanoutListener2&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;topicListenerStar&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.itheima.rabbitmq.listener.TopicListenerStar&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;topicListenerWell&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.itheima.rabbitmq.listener.TopicListenerWell&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;topicListenerWell2&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.itheima.rabbitmq.listener.TopicListenerWell2&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener-container</span> <span class="hljs-attr">connection-factory</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span> <span class="hljs-attr">auto-declare</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;springQueueListener&quot;</span> <span class="hljs-attr">queue-names</span>=<span class="hljs-string">&quot;spring_queue&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;fanoutListener1&quot;</span> <span class="hljs-attr">queue-names</span>=<span class="hljs-string">&quot;spring_fanout_queue_1&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;fanoutListener2&quot;</span> <span class="hljs-attr">queue-names</span>=<span class="hljs-string">&quot;spring_fanout_queue_2&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;topicListenerStar&quot;</span> <span class="hljs-attr">queue-names</span>=<span class="hljs-string">&quot;spring_topic_queue_star&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;topicListenerWell&quot;</span> <span class="hljs-attr">queue-names</span>=<span class="hljs-string">&quot;spring_topic_queue_well&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;topicListenerWell2&quot;</span> <span class="hljs-attr">queue-names</span>=<span class="hljs-string">&quot;spring_topic_queue_well2&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:listener-container</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="消息监听器"><a href="#消息监听器" class="headerlink" title="消息监听器"></a>消息监听器</h3><h4 id="1）队列监听器"><a href="#1）队列监听器" class="headerlink" title="1）队列监听器"></a>1）队列监听器</h4><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\itheima\rabbitmq\listener\SpringQueueListener.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringQueueListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MessageListener</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String msg = <span class="hljs-keyword">new</span> String(message.getBody(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br><br>            System.out.printf(<span class="hljs-string">&quot;接收路由名称为：%s，路由键为：%s，队列名为：%s的消息：%s \n&quot;</span>,<br>                    message.getMessageProperties().getReceivedExchange(),<br>                    message.getMessageProperties().getReceivedRoutingKey(),<br>                    message.getMessageProperties().getConsumerQueue(),<br>                    msg);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="2）广播监听器1"><a href="#2）广播监听器1" class="headerlink" title="2）广播监听器1"></a>2）广播监听器1</h4><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\itheima\rabbitmq\listener\FanoutListener1.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FanoutListener1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MessageListener</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String msg = <span class="hljs-keyword">new</span> String(message.getBody(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br><br>            System.out.printf(<span class="hljs-string">&quot;广播监听器1：接收路由名称为：%s，路由键为：%s，队列名为：%s的消息：%s \n&quot;</span>,<br>                    message.getMessageProperties().getReceivedExchange(),<br>                    message.getMessageProperties().getReceivedRoutingKey(),<br>                    message.getMessageProperties().getConsumerQueue(),<br>                    msg);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="3）广播监听器2"><a href="#3）广播监听器2" class="headerlink" title="3）广播监听器2"></a>3）广播监听器2</h4><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\itheima\rabbitmq\listener\FanoutListener2.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FanoutListener2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MessageListener</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String msg = <span class="hljs-keyword">new</span> String(message.getBody(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br><br>            System.out.printf(<span class="hljs-string">&quot;广播监听器2：接收路由名称为：%s，路由键为：%s，队列名为：%s的消息：%s \n&quot;</span>,<br>                    message.getMessageProperties().getReceivedExchange(),<br>                    message.getMessageProperties().getReceivedRoutingKey(),<br>                    message.getMessageProperties().getConsumerQueue(),<br>                    msg);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4）星号通配符监听器"><a href="#4）星号通配符监听器" class="headerlink" title="4）星号通配符监听器"></a>4）星号通配符监听器</h4><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\itheima\rabbitmq\listener\TopicListenerStar.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TopicListenerStar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MessageListener</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String msg = <span class="hljs-keyword">new</span> String(message.getBody(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br><br>            System.out.printf(<span class="hljs-string">&quot;通配符*监听器：接收路由名称为：%s，路由键为：%s，队列名为：%s的消息：%s \n&quot;</span>,<br>                    message.getMessageProperties().getReceivedExchange(),<br>                    message.getMessageProperties().getReceivedRoutingKey(),<br>                    message.getMessageProperties().getConsumerQueue(),<br>                    msg);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="5）井号通配符监听器"><a href="#5）井号通配符监听器" class="headerlink" title="5）井号通配符监听器"></a>5）井号通配符监听器</h4><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\itheima\rabbitmq\listener\TopicListenerWell.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TopicListenerWell</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MessageListener</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String msg = <span class="hljs-keyword">new</span> String(message.getBody(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br><br>            System.out.printf(<span class="hljs-string">&quot;通配符#监听器：接收路由名称为：%s，路由键为：%s，队列名为：%s的消息：%s \n&quot;</span>,<br>                    message.getMessageProperties().getReceivedExchange(),<br>                    message.getMessageProperties().getReceivedRoutingKey(),<br>                    message.getMessageProperties().getConsumerQueue(),<br>                    msg);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="6）井号通配符监听器2"><a href="#6）井号通配符监听器2" class="headerlink" title="6）井号通配符监听器2"></a>6）井号通配符监听器2</h4><p>创建 <code>spring-rabbitmq-consumer\src\main\java\com\itheima\rabbitmq\listener\TopicListenerWell2.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TopicListenerWell2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MessageListener</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String msg = <span class="hljs-keyword">new</span> String(message.getBody(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br><br>            System.out.printf(<span class="hljs-string">&quot;通配符#监听器2：接收路由名称为：%s，路由键为：%s，队列名为：%s的消息：%s \n&quot;</span>,<br>                    message.getMessageProperties().getReceivedExchange(),<br>                    message.getMessageProperties().getReceivedRoutingKey(),<br>                    message.getMessageProperties().getConsumerQueue(),<br>                    msg);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="SpringBoot整合RabbitMQ"><a href="#SpringBoot整合RabbitMQ" class="headerlink" title="SpringBoot整合RabbitMQ"></a>SpringBoot整合RabbitMQ</h1><p>在Spring项目中，可以使用Spring-Rabbit去操作RabbitMQ<br><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-amqp">https://github.com/spring-projects/spring-amqp</a></p>
<p>尤其是在spring boot项目中只需要引入对应的amqp启动器依赖即可，方便的使用RabbitTemplate发送消息，使用注解接收消息。</p>
<p><em>一般在开发过程中</em>：</p>
<p><strong>生产者工程：</strong></p>
<ol>
<li><p>application.yml文件配置RabbitMQ相关信息；</p>
</li>
<li><p>在生产者工程中编写配置类，用于创建交换机和队列，并进行绑定</p>
</li>
<li><p>注入RabbitTemplate对象，通过RabbitTemplate对象发送消息到交换机</p>
</li>
</ol>
<p><strong>消费者工程：</strong></p>
<ol>
<li><p>application.yml文件配置RabbitMQ相关信息</p>
</li>
<li><p>创建消息处理类，用于接收队列中的消息并进行处理</p>
</li>
</ol>
<h2 id="搭建生产者工程"><a href="#搭建生产者工程" class="headerlink" title="搭建生产者工程"></a>搭建生产者工程</h2><h3 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h3><p>创建生产者工程springboot-rabbitmq-producer</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1558321303612.png" srcset="/img/loading.gif" alt="1556072078816"></p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1558321417385.png" srcset="/img/loading.gif" alt="1556072084653"></p>
<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>修改pom.xml文件内容为如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springboot-rabbitmq-producer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h3 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.rabbitmq;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ProducerApplication.class);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h3 id="配置RabbitMQ"><a href="#配置RabbitMQ" class="headerlink" title="配置RabbitMQ"></a>配置RabbitMQ</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>创建application.yml，内容如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/itcast</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">heima</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">heima</span><br></code></pre></td></tr></table></figure>



<h4 id="绑定交换机和队列"><a href="#绑定交换机和队列" class="headerlink" title="绑定交换机和队列"></a>绑定交换机和队列</h4><p>创建RabbitMQ队列与交换机绑定的配置类com.itheima.rabbitmq.config.RabbitMQConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.rabbitmq.config;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.core.*;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;<br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ITEM_TOPIC_EXCHANGE = <span class="hljs-string">&quot;item_topic_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ITEM_QUEUE = <span class="hljs-string">&quot;item_queue&quot;</span>;<br><br>    <span class="hljs-comment">//声明交换机</span><br>    <span class="hljs-meta">@Bean(&quot;itemTopicExchange&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">topicExchange</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.topicExchange(ITEM_TOPIC_EXCHANGE).durable(<span class="hljs-keyword">true</span>).build();<br>    &#125;<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean(&quot;itemQueue&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">itemQueue</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(ITEM_QUEUE).build();<br>    &#125;<br><br>    <span class="hljs-comment">//绑定队列和交换机</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">itemQueueExchange</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(&quot;itemQueue&quot;)</span> Queue queue,</span></span><br><span class="hljs-function"><span class="hljs-params">                                     <span class="hljs-meta">@Qualifier(&quot;itemTopicExchange&quot;)</span> Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;item.#&quot;</span>).noargs();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="搭建消费者工程"><a href="#搭建消费者工程" class="headerlink" title="搭建消费者工程"></a>搭建消费者工程</h2><h3 id="创建工程-1"><a href="#创建工程-1" class="headerlink" title="创建工程"></a>创建工程</h3><p>创建消费者工程springboot-rabbitmq-consumer</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1558322109359.png" srcset="/img/loading.gif" alt="1556073553841"></p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1558322192435.png" srcset="/img/loading.gif" alt="1556073567786"></p>
<h3 id="添加依赖-1"><a href="#添加依赖-1" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>修改pom.xml文件内容为如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springboot-rabbitmq-consumer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h3 id="启动类-1"><a href="#启动类-1" class="headerlink" title="启动类"></a>启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.rabbitmq;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ConsumerApplication.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="配置RabbitMQ-1"><a href="#配置RabbitMQ-1" class="headerlink" title="配置RabbitMQ"></a>配置RabbitMQ</h3><p>创建application.yml，内容如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.91</span><span class="hljs-number">.130</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/itcast</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">heima</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">heima</span><br></code></pre></td></tr></table></figure>



<h3 id="消息监听处理类"><a href="#消息监听处理类" class="headerlink" title="消息监听处理类"></a>消息监听处理类</h3><p>编写消息监听器com.itheima.rabbitmq.listener.MyListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.rabbitmq.listener;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyListener</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 监听某个队列的消息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 接收到的消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = &quot;item_queue&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">myListener1</span><span class="hljs-params">(String message)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者接收到的消息为：&quot;</span> + message);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在生产者工程springboot-rabbitmq-producer中创建测试类，发送消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.rabbitmq;<br><br><span class="hljs-keyword">import</span> com.itheima.rabbitmq.config.RabbitMQConfig;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQTest</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>&#123;<br>        rabbitTemplate.convertAndSend(RabbitMQConfig.ITEM_TOPIC_EXCHANGE, <span class="hljs-string">&quot;item.insert&quot;</span>, <span class="hljs-string">&quot;商品新增，routing key 为item.insert&quot;</span>);<br>        rabbitTemplate.convertAndSend(RabbitMQConfig.ITEM_TOPIC_EXCHANGE, <span class="hljs-string">&quot;item.update&quot;</span>, <span class="hljs-string">&quot;商品修改，routing key 为item.update&quot;</span>);<br>        rabbitTemplate.convertAndSend(RabbitMQConfig.ITEM_TOPIC_EXCHANGE, <span class="hljs-string">&quot;item.delete&quot;</span>, <span class="hljs-string">&quot;商品删除，routing key 为item.delete&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>先运行上述测试程序（交换机和队列才能先被声明和绑定），然后启动消费者；在消费者工程springboot-rabbitmq-consumer中控制台查看是否接收到对应消息。</p>
<p>另外；也可以在RabbitMQ的管理控制台中查看到交换机与队列的绑定：</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1556074827222.png" srcset="/img/loading.gif" alt="1556074827222"></p>
<h1 id="RabbitMQ高级特性"><a href="#RabbitMQ高级特性" class="headerlink" title="RabbitMQ高级特性"></a>RabbitMQ高级特性</h1><p>高级特性介绍中使用的代码目录，详细查看代码附录</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224214156170.png" srcset="/img/loading.gif" alt="image-20210224214156170"></p>
<h2 id="消息可靠性投递"><a href="#消息可靠性投递" class="headerlink" title="消息可靠性投递"></a>消息可靠性投递</h2><p>在使用 RabbitMQ 的时候，作为消息发送方希望杜绝任何消息丢失或者投递失败场景。RabbitMQ 为我们提供了两种方式用来控制消息的投递可靠性模式。</p>
<ul>
<li><p>confirm 确认模式</p>
</li>
<li><p>return 退回模式</p>
</li>
</ul>
<p>rabbitmq 整个消息投递的路径为：</p>
<p>producer—&gt;rabbitmq broker—&gt;exchange—&gt;queue—&gt;consumer</p>
<ul>
<li><p>消息从 producer 到 exchange 则会返回一个 confirmCallback 。</p>
</li>
<li><p>消息从 exchange–&gt;queue 投递失败则会返回一个 returnCallback 。</p>
</li>
</ul>
<p>我们将利用这两个 callback 控制消息的可靠性投递</p>
<h2 id="confirm-确认模式"><a href="#confirm-确认模式" class="headerlink" title="confirm 确认模式"></a>confirm 确认模式</h2><p>1、设置ConnectionFactory的publisher-confirms=”true” 开启确认模式。</p>
<p><code>src/main/resources/spring-rabbitmq-producer.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:connection-factory</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">username</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">virtual-host</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">publisher-confirms</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">                        </span><br><span class="hljs-tag">    /&gt;</span><br></code></pre></td></tr></table></figure>

<p>2、使用rabbitTemplate.setConfirmCallback设置回调函数。当消息发送到exchange后回调confirm方法。在方法中判断ack，如果为true，则发送成功，如果为false，则发送失败，需要处理。</p>
<p><code>com/itheima/test/ProducerTest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 确认模式：</span><br><span class="hljs-comment">     * 步骤：</span><br><span class="hljs-comment">     * 1. 确认模式开启：ConnectionFactory中开启publisher-confirms=&quot;true&quot;</span><br><span class="hljs-comment">     * 2. 在rabbitTemplate定义ConfirmCallBack回调函数</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testConfirm</span><span class="hljs-params">()</span> </span>&#123;<br><br>        <span class="hljs-comment">//2. 定义回调</span><br>        rabbitTemplate.setConfirmCallback(<span class="hljs-keyword">new</span> RabbitTemplate.ConfirmCallback() &#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             *</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> correlationData 相关配置信息</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> ack   exchange交换机 是否成功收到了消息。true 成功，false代表失败</span><br><span class="hljs-comment">             * <span class="hljs-doctag">@param</span> cause 失败原因</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-keyword">boolean</span> ack, String cause)</span> </span>&#123;<br>                System.out.println(<span class="hljs-string">&quot;confirm方法被执行了....&quot;</span>);<br><br>                <span class="hljs-keyword">if</span> (ack) &#123;<br>                    <span class="hljs-comment">//接收成功</span><br>                    System.out.println(<span class="hljs-string">&quot;接收成功消息&quot;</span> + cause);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">//接收失败</span><br>                    System.out.println(<span class="hljs-string">&quot;接收失败消息&quot;</span> + cause);<br>                    <span class="hljs-comment">//做一些处理，让消息再次发送。</span><br>                &#125;<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-comment">//3. 发送消息</span><br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_confirm111&quot;</span>, <span class="hljs-string">&quot;confirm&quot;</span>, <span class="hljs-string">&quot;message confirm....&quot;</span>);<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="return-退回模式"><a href="#return-退回模式" class="headerlink" title="return 退回模式"></a>return 退回模式</h2><p>1、设置ConnectionFactory的publisher-returns=”true” 开启 退回模式。</p>
<p><code>src/main/resources/spring-rabbitmq-producer.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:connection-factory</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">username</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">virtual-host</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">publisher-confirms</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">publisher-returns</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">    /&gt;</span><br></code></pre></td></tr></table></figure>

<p>2、使用rabbitTemplate.setReturnCallback设置退回函数，当消息从exchange路由到queue失败后，如果设置了rabbitTemplate.setMandatory(true)参数，则会将消息退回给producer。并执行回调函数returnedMessage。</p>
<p><code>com/itheima/test/ProducerTest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 回退模式： 当消息发送给Exchange后，Exchange路由到Queue失败是 才会执行 ReturnCallBack</span><br><span class="hljs-comment">    * 步骤：</span><br><span class="hljs-comment">    * 1. 开启回退模式:publisher-returns=&quot;true&quot;</span><br><span class="hljs-comment">    * 2. 设置ReturnCallBack</span><br><span class="hljs-comment">    * 3. 设置Exchange处理消息的模式：</span><br><span class="hljs-comment">    * 1. 如果消息没有路由到Queue，则丢弃消息（默认）</span><br><span class="hljs-comment">    * 2. 如果消息没有路由到Queue，返回给消息发送方ReturnCallBack</span><br><span class="hljs-comment">    */</span><br><br>   <span class="hljs-meta">@Test</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReturn</span><span class="hljs-params">()</span> </span>&#123;<br><br>       <span class="hljs-comment">//设置交换机处理失败消息的模式</span><br>       rabbitTemplate.setMandatory(<span class="hljs-keyword">true</span>);<br><br>       <span class="hljs-comment">//2.设置ReturnCallBack</span><br>       rabbitTemplate.setReturnCallback(<span class="hljs-keyword">new</span> RabbitTemplate.ReturnCallback() &#123;<br>           <span class="hljs-comment">/**</span><br><span class="hljs-comment">            *</span><br><span class="hljs-comment">            * <span class="hljs-doctag">@param</span> message   消息对象</span><br><span class="hljs-comment">            * <span class="hljs-doctag">@param</span> replyCode 错误码</span><br><span class="hljs-comment">            * <span class="hljs-doctag">@param</span> replyText 错误信息</span><br><span class="hljs-comment">            * <span class="hljs-doctag">@param</span> exchange  交换机</span><br><span class="hljs-comment">            * <span class="hljs-doctag">@param</span> routingKey 路由键</span><br><span class="hljs-comment">            */</span><br>           <span class="hljs-meta">@Override</span><br>           <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">returnedMessage</span><span class="hljs-params">(Message message, <span class="hljs-keyword">int</span> replyCode, String replyText, String exchange, String routingKey)</span> </span>&#123;<br>               System.out.println(<span class="hljs-string">&quot;return 执行了....&quot;</span>);<br><br>               System.out.println(message);<br>               System.out.println(replyCode);<br>               System.out.println(replyText);<br>               System.out.println(exchange);<br>               System.out.println(routingKey);<br><br>               <span class="hljs-comment">//处理</span><br>           &#125;a]<br>       &#125;);<br><br><br>       <span class="hljs-comment">//3. 发送消息</span><br>       rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_confirm&quot;</span>, <span class="hljs-string">&quot;confirm&quot;</span>, <span class="hljs-string">&quot;message confirm....&quot;</span>);<br>   &#125;<br><br></code></pre></td></tr></table></figure>

<p>Ø在RabbitMQ中也提供了事务机制，但是性能较差，此处不做讲解。</p>
<p>使用channel下列方法，完成事务控制：</p>
<p>txSelect(), 用于将当前channel设置成transaction模式</p>
<p>txCommit()，用于提交事务</p>
<p>txRollback(),用于回滚事务</p>
<h2 id="Consumer-ACK"><a href="#Consumer-ACK" class="headerlink" title="Consumer ACK"></a>Consumer ACK</h2><p>ack指Acknowledge，确认。 表示消费端收到消息后的确认方式。</p>
<p>有三种确认方式：</p>
<ul>
<li><p>自动确认：acknowledge=”none”</p>
</li>
<li><p>手动确认：acknowledge=”manual”</p>
</li>
<li><p>根据异常情况确认：acknowledge=”auto”，（这种方式使用麻烦，不作讲解）</p>
</li>
</ul>
<p>其中自动确认是指，当消息一旦被Consumer接收到，则自动确认收到，并将相应 message 从 RabbitMQ 的消息缓存中移除。但是在实际业务处理中，很可能消息接收到，业务处理出现异常，那么该消息就会丢失。如果设置了手动确认方式，则需要在业务处理成功后，调用channel.basicAck()，手动签收，如果出现异常，则调用channel.basicNack()方法，让其自动重新发送消息。</p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>1、在rabbit:listener-container标签中设置acknowledge属性，设置ack方式 none：自动确认，manual：手动确认</p>
<p><code>src/main/resources/spring-rabbitmq-consumer.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:rabbit</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/context</span></span><br><span class="hljs-tag"><span class="hljs-string">       https://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/rabbit</span></span><br><span class="hljs-tag"><span class="hljs-string">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--加载配置文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;classpath:rabbitmq.properties&quot;</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:connection-factory</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span> <span class="hljs-attr">host</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">username</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span><br><span class="hljs-tag">                               <span class="hljs-attr">virtual-host</span>=<span class="hljs-string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span>/&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.itheima.listener&quot;</span> /&gt;</span><br><br>    <span class="hljs-comment">&lt;!--定义监听器容器--&gt;</span><br>    <span class="hljs-comment">&lt;!--acknowledge=&quot;manual&quot;手动--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener-container</span> <span class="hljs-attr">connection-factory</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span> <span class="hljs-attr">acknowledge</span>=<span class="hljs-string">&quot;manual&quot;</span> <span class="hljs-attr">prefetch</span>=<span class="hljs-string">&quot;1&quot;</span> &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;ackListener&quot;</span> <span class="hljs-attr">queue-names</span>=<span class="hljs-string">&quot;test_queue_confirm&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:listener</span>&gt;</span><br>       <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:listener-container</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2、如果在消费端没有出现异常，则调用channel.basicAck(deliveryTag,false);方法确认签收消息</p>
<p>如果出现异常，则在catch中调用 basicNack或 basicReject，拒绝消息，让MQ重新发送消息。</p>
<p><code>src/main/java/com/itheima/listener/AckListener.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Consumer ACK机制：</span><br><span class="hljs-comment"> *  1. 设置手动签收。acknowledge=&quot;manual&quot;</span><br><span class="hljs-comment"> *  2. 让监听器类实现ChannelAwareMessageListener接口</span><br><span class="hljs-comment"> *  3. 如果消息成功处理，则调用channel的 basicAck()签收</span><br><span class="hljs-comment"> *  4. 如果消息处理失败，则调用channel的basicNack()拒绝签收，broker重新发送给consumer</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AckListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ChannelAwareMessageListener</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message, Channel channel)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">long</span> deliveryTag = message.getMessageProperties().getDeliveryTag();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//1.接收转换消息</span><br>            System.out.println(<span class="hljs-keyword">new</span> String(message.getBody()));<br><br>            <span class="hljs-comment">//2. 处理业务逻辑</span><br>            System.out.println(<span class="hljs-string">&quot;处理业务逻辑...&quot;</span>);<br>            <span class="hljs-keyword">int</span> i = <span class="hljs-number">3</span>/<span class="hljs-number">0</span>;<span class="hljs-comment">//出现错误</span><br>            <span class="hljs-comment">//3. 手动签收</span><br>            channel.basicAck(deliveryTag,<span class="hljs-keyword">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">//e.printStackTrace();</span><br><br>            <span class="hljs-comment">//4.拒绝签收</span><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            第三个参数：requeue：重回队列。如果设置为true，则消息重新回到queue，broker会重新发送该消息给消费端</span><br><span class="hljs-comment">             */</span><br>            channel.basicNack(deliveryTag,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">true</span>);<br>            <span class="hljs-comment">//channel.basicReject(deliveryTag,true);</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="消费端限流"><a href="#消费端限流" class="headerlink" title="消费端限流"></a>消费端限流</h2><p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224215000420.png" srcset="/img/loading.gif" alt="image-20210224215000420"></p>
<h3 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h3><p>1、在<a href="rabbit:listener-container">rabbit:listener-container</a> 中配置 prefetch属性设置消费端一次拉取多少消息、</p>
<p>2、消费端的确认模式一定为手动确认。acknowledge=”manual”</p>
<p><code>src/main/resources/spring-rabbitmq-consumer.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--定义监听器容器--&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener-container</span> <span class="hljs-attr">connection-factory</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span> <span class="hljs-attr">acknowledge</span>=<span class="hljs-string">&quot;manual&quot;</span> <span class="hljs-attr">prefetch</span>=<span class="hljs-string">&quot;1&quot;</span> &gt;</span><br>	 <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;qosListener&quot;</span> <span class="hljs-attr">queue-names</span>=<span class="hljs-string">&quot;test_queue_confirm&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:listener</span>&gt;</span>--&gt;<br>   <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:listener-container</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>3、实现</p>
<p><code>src/main/java/com/itheima/listener/QosListener.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Consumer 限流机制</span><br><span class="hljs-comment"> *  1. 确保ack机制为手动确认。</span><br><span class="hljs-comment"> *  2. listener-container配置属性</span><br><span class="hljs-comment"> *      perfetch = 1,表示消费端每次从mq拉去一条消息来消费，直到手动确认消费完毕后，才会继续拉去下一条消息。</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QosListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ChannelAwareMessageListener</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message, Channel channel)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        <span class="hljs-comment">//1.获取消息</span><br>        System.out.println(<span class="hljs-keyword">new</span> String(message.getBody()));<br><br>        <span class="hljs-comment">//2. 处理业务逻辑</span><br><br>        <span class="hljs-comment">//3. 签收</span><br>        channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="hljs-keyword">true</span>);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="TTL"><a href="#TTL" class="headerlink" title="TTL"></a>TTL</h2><p>TTL 全称 Time To Live（存活时间/过期时间）。</p>
<p>当消息到达存活时间后，还没有被消费，会被自动清除。</p>
<p>RabbitMQ可以对消息设置过期时间，也可以对整个队列（Queue）设置过期时间。</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224220328216.png" srcset="/img/loading.gif" alt="image-20210224220328216"></p>
<h3 id="控制台实现"><a href="#控制台实现" class="headerlink" title="控制台实现"></a>控制台实现</h3><p>添加队列</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224221215187.png" srcset="/img/loading.gif" alt="image-20210224221215187"></p>
<p>添加交换机</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224221408696.png" srcset="/img/loading.gif" alt="image-20210224221408696"></p>
<p>为交换机添加队列</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224221620373.png" srcset="/img/loading.gif" alt="image-20210224221620373"></p>
<p>绑定成功</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224221825200.png" srcset="/img/loading.gif" alt="image-20210224221825200"></p>
<p>交换机中发布消息</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224221941354.png" srcset="/img/loading.gif" alt="image-20210224221941354"></p>
<p>回到队列中可以看见消息过了十秒被清除了</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224222044094.png" srcset="/img/loading.gif" alt="image-20210224222044094"></p>
<h3 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h3><p>1、设置队列过期时间使用参数：x-message-ttl，单位：ms(毫秒)，会对整个队列消息统一过期。</p>
<p>2、设置消息过期时间使用参数：expiration。单位：ms(毫秒)，当该消息在队列头部时（消费时），会单独判断这一消息是否过期。</p>
<p>3、如果两者都进行了设置，以时间短的为准。</p>
<p><code>src/main/resources/spring-rabbitmq-producer.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--ttl--&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;test_queue_ttl&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;test_queue_ttl&quot;</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--设置queue的参数--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue-arguments</span>&gt;</span><br>           <span class="hljs-comment">&lt;!--x-message-ttl指队列的过期时间--&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;x-message-ttl&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;100000&quot;</span> <span class="hljs-attr">value-type</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:queue-arguments</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:queue</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">rabbit:topic-exchange</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;test_exchange_ttl&quot;</span> &gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:binding</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;ttl.#&quot;</span> <span class="hljs-attr">queue</span>=<span class="hljs-string">&quot;test_queue_ttl&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:binding</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:topic-exchange</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>测试</p>
<p><code>src/test/java/com/itheima/test/ProducerTest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * TTL:过期时间</span><br><span class="hljs-comment">    *  1. 队列统一过期</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    *  2. 消息单独过期</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * 如果设置了消息的过期时间，也设置了队列的过期时间，它以时间短的为准。</span><br><span class="hljs-comment">    * 队列过期后，会将队列所有消息全部移除。</span><br><span class="hljs-comment">    * 消息过期后，只有消息在队列顶端，才会判断其是否过期(移除掉)</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Test</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testTtl</span><span class="hljs-params">()</span> </span>&#123;<br><br><br>     <span class="hljs-comment">/*  for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="hljs-comment">           // 发送消息</span><br><span class="hljs-comment">           rabbitTemplate.convertAndSend(&quot;test_exchange_ttl&quot;, &quot;ttl.hehe&quot;, &quot;message ttl....&quot;);</span><br><span class="hljs-comment">       &#125;*/</span><br><br>     <span class="hljs-comment">// 消息后处理对象，设置一些消息的参数信息</span><br>       MessagePostProcessor messagePostProcessor = <span class="hljs-keyword">new</span> MessagePostProcessor() &#123;<br><br>           <span class="hljs-meta">@Override</span><br>           <span class="hljs-function"><span class="hljs-keyword">public</span> Message <span class="hljs-title">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException </span>&#123;<br>               <span class="hljs-comment">//1.设置message的信息</span><br>               message.getMessageProperties().setExpiration(<span class="hljs-string">&quot;5000&quot;</span>);<span class="hljs-comment">//消息的过期时间</span><br>               <span class="hljs-comment">//2.返回该消息</span><br>               <span class="hljs-keyword">return</span> message;<br>           &#125;<br>       &#125;;<br><br><br>       <span class="hljs-comment">//消息单独过期</span><br>       <span class="hljs-comment">//rabbitTemplate.convertAndSend(&quot;test_exchange_ttl&quot;, &quot;ttl.hehe&quot;, &quot;message ttl....&quot;,messagePostProcessor);</span><br><br><br>       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>           <span class="hljs-keyword">if</span>(i == <span class="hljs-number">5</span>)&#123;<br>               <span class="hljs-comment">//消息单独过期</span><br>               rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_ttl&quot;</span>, <span class="hljs-string">&quot;ttl.hehe&quot;</span>, <span class="hljs-string">&quot;message ttl....&quot;</span>,messagePostProcessor);<br>           &#125;<span class="hljs-keyword">else</span>&#123;<br>               <span class="hljs-comment">//不过期的消息</span><br>               rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_ttl&quot;</span>, <span class="hljs-string">&quot;ttl.hehe&quot;</span>, <span class="hljs-string">&quot;message ttl....&quot;</span>);<br><br>           &#125;<br><br>       &#125;<br><br><br>   &#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h2><p>死信队列，英文缩写：DLX </p>
<p>Dead Letter Exchange（死信交换机）</p>
<p>当消息成为Dead message后，可以被重新发送到另一个交换机，这个交换机就是DLX</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224231141724.png" srcset="/img/loading.gif" alt="image-20210224231141724"></p>
<p><strong>消息成为死信的三种情况：</strong></p>
<ul>
<li><p>队列消息长度到达限制；</p>
</li>
<li><p>消费者拒接消费消息，basicNack/basicReject,并且不把消息重新放入原目标队列,requeue=false；</p>
</li>
<li><p>原队列存在消息过期设置，消息到达超时时间未被消费</p>
</li>
</ul>
<h3 id="代码实现-3"><a href="#代码实现-3" class="headerlink" title="代码实现"></a>代码实现</h3><p><code>src/main/resources/spring-rabbitmq-producer.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">       死信队列：</span><br><span class="hljs-comment">           1. 声明正常的队列(test_queue_dlx)和交换机(test_exchange_dlx)</span><br><span class="hljs-comment">           2. 声明死信队列(queue_dlx)和死信交换机(exchange_dlx)</span><br><span class="hljs-comment">           3. 正常队列绑定死信交换机</span><br><span class="hljs-comment">               设置两个参数：</span><br><span class="hljs-comment">                   * x-dead-letter-exchange：死信交换机名称</span><br><span class="hljs-comment">                   * x-dead-letter-routing-key：发送给死信交换机的routingkey</span><br><span class="hljs-comment">   --&gt;</span><br><br>   <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">       1. 声明正常的队列(test_queue_dlx)和交换机(test_exchange_dlx)</span><br><span class="hljs-comment">   --&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;test_queue_dlx&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;test_queue_dlx&quot;</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--3. 正常队列绑定死信交换机--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue-arguments</span>&gt;</span><br>           <span class="hljs-comment">&lt;!--3.1 x-dead-letter-exchange：死信交换机名称--&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;exchange_dlx&quot;</span> /&gt;</span><br><br>           <span class="hljs-comment">&lt;!--3.2 x-dead-letter-routing-key：发送给死信交换机的routingkey--&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;x-dead-letter-routing-key&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;dlx.hehe&quot;</span> /&gt;</span><br><br>           <span class="hljs-comment">&lt;!--4.1 设置队列的过期时间 ttl--&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;x-message-ttl&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;10000&quot;</span> <span class="hljs-attr">value-type</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span> /&gt;</span><br>           <span class="hljs-comment">&lt;!--4.2 设置队列的长度限制 max-length --&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;x-max-length&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;10&quot;</span> <span class="hljs-attr">value-type</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span> /&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:queue-arguments</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:queue</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:topic-exchange</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;test_exchange_dlx&quot;</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:binding</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;test.dlx.#&quot;</span> <span class="hljs-attr">queue</span>=<span class="hljs-string">&quot;test_queue_dlx&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:binding</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:topic-exchange</span>&gt;</span><br><br><br>   <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">      2. 声明死信队列(queue_dlx)和死信交换机(exchange_dlx)</span><br><span class="hljs-comment">  --&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;queue_dlx&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;queue_dlx&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:queue</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:topic-exchange</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;exchange_dlx&quot;</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:binding</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;dlx.#&quot;</span> <span class="hljs-attr">queue</span>=<span class="hljs-string">&quot;queue_dlx&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:binding</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:topic-exchange</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p><code>src/test/java/com/itheima/test/ProducerTest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发送测试死信消息：</span><br><span class="hljs-comment">     *  1. 过期时间</span><br><span class="hljs-comment">     *  2. 长度限制</span><br><span class="hljs-comment">     *  3. 消息拒收</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDlx</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//1. 测试过期时间，死信消息</span><br>        <span class="hljs-comment">//rabbitTemplate.convertAndSend(&quot;test_exchange_dlx&quot;,&quot;test.dlx.haha&quot;,&quot;我是一条消息，我会死吗？&quot;);</span><br><br>        <span class="hljs-comment">//2. 测试长度限制后，消息死信</span><br>       <span class="hljs-comment">/* for (int i = 0; i &lt; 20; i++) &#123;</span><br><span class="hljs-comment">            rabbitTemplate.convertAndSend(&quot;test_exchange_dlx&quot;,&quot;test.dlx.haha&quot;,&quot;我是一条消息，我会死吗？&quot;);</span><br><span class="hljs-comment">        &#125;*/</span><br><br>        <span class="hljs-comment">//3. 测试消息拒收</span><br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;test_exchange_dlx&quot;</span>,<span class="hljs-string">&quot;test.dlx.haha&quot;</span>,<span class="hljs-string">&quot;我是一条消息，我会死吗？&quot;</span>);<br><br>    &#125;<br><br><br></code></pre></td></tr></table></figure>

<p>消费者</p>
<p><code>src/main/resources/spring-rabbitmq-consumer.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--定义监听器容器--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener-container</span> <span class="hljs-attr">connection-factory</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span> <span class="hljs-attr">acknowledge</span>=<span class="hljs-string">&quot;manual&quot;</span> <span class="hljs-attr">prefetch</span>=<span class="hljs-string">&quot;1&quot;</span> &gt;</span><br>        <span class="hljs-comment">&lt;!--定义监听器，监听正常队列--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dlxListener&quot;</span> <span class="hljs-attr">queue-names</span>=<span class="hljs-string">&quot;test_queue_dlx&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:listener</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:listener-container</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><code>src/main/java/com/itheima/listener/DlxListener.java    </code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DlxListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ChannelAwareMessageListener</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message, Channel channel)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">long</span> deliveryTag = message.getMessageProperties().getDeliveryTag();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//1.接收转换消息</span><br>            System.out.println(<span class="hljs-keyword">new</span> String(message.getBody()));<br><br>            <span class="hljs-comment">//2. 处理业务逻辑</span><br>            System.out.println(<span class="hljs-string">&quot;处理业务逻辑...&quot;</span>);<br>            <span class="hljs-keyword">int</span> i = <span class="hljs-number">3</span>/<span class="hljs-number">0</span>;<span class="hljs-comment">//出现错误</span><br>            <span class="hljs-comment">//3. 手动签收</span><br>            channel.basicAck(deliveryTag,<span class="hljs-keyword">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">//e.printStackTrace();</span><br>            System.out.println(<span class="hljs-string">&quot;出现异常，拒绝接受&quot;</span>);<br>            <span class="hljs-comment">//4.拒绝签收，不重回队列 requeue=false</span><br>            channel.basicNack(deliveryTag,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>由此可见：</p>
<ul>
<li>死信交换机和死信队列和普通的没有区别</li>
<li>当消息成为死信后，如果该队列绑定了死信交换机，则消息会被死信交换机重新路由到死信队列</li>
</ul>
<h2 id="延迟队列"><a href="#延迟队列" class="headerlink" title="延迟队列"></a>延迟队列</h2><p>延迟队列，即消息进入队列后不会立即被消费，只有到达指定时间后，才会被消费。</p>
<p>如需求：1）下单后，30分钟未支付，取消订单，回滚库存。2） 新用户注册成功7天后，发送短信问候。</p>
<p>实现方式：</p>
<ul>
<li><p>定时器（效果差）</p>
</li>
<li><p>延迟队列</p>
</li>
</ul>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224232518669.png" srcset="/img/loading.gif" alt="image-20210224232518669"></p>
<p>很可惜，在RabbitMQ中并未提供延迟队列功能。</p>
<p>但是可以使用：==TTL+死信队列== 组合实现延迟队列的效果。。</p>
<h3 id="代码实现-4"><a href="#代码实现-4" class="headerlink" title="代码实现"></a>代码实现</h3><p><code>src/main/resources/spring-rabbitmq-producer.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">       延迟队列：</span><br><span class="hljs-comment">           1. 定义正常交换机（order_exchange）和队列(order_queue)</span><br><span class="hljs-comment">           2. 定义死信交换机（order_exchange_dlx）和队列(order_queue_dlx)</span><br><span class="hljs-comment">           3. 绑定，设置正常队列过期时间为30分钟</span><br><span class="hljs-comment">   --&gt;</span><br>   <span class="hljs-comment">&lt;!-- 1. 定义正常交换机（order_exchange）和队列(order_queue)--&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;order_queue&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;order_queue&quot;</span>&gt;</span><br>       <span class="hljs-comment">&lt;!-- 3. 绑定，设置正常队列过期时间为30分钟--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue-arguments</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;order_exchange_dlx&quot;</span> /&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;x-dead-letter-routing-key&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;dlx.order.cancel&quot;</span> /&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;x-message-ttl&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;10000&quot;</span> <span class="hljs-attr">value-type</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span> /&gt;</span><br><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:queue-arguments</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:queue</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:topic-exchange</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;order_exchange&quot;</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:binding</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;order.#&quot;</span> <span class="hljs-attr">queue</span>=<span class="hljs-string">&quot;order_queue&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:binding</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:topic-exchange</span>&gt;</span><br><br>   <span class="hljs-comment">&lt;!--  2. 定义死信交换机（order_exchange_dlx）和队列(order_queue_dlx)--&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:queue</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;order_queue_dlx&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;order_queue_dlx&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:queue</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:topic-exchange</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;order_exchange_dlx&quot;</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">rabbit:binding</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;dlx.order.#&quot;</span> <span class="hljs-attr">queue</span>=<span class="hljs-string">&quot;order_queue_dlx&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:binding</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:bindings</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:topic-exchange</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p><code>src/test/java/com/itheima/test/ProducerTest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">testDelay</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        <span class="hljs-comment">//1.发送订单消息。 将来是在订单系统中，下单成功后，发送消息</span><br>        rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;order_exchange&quot;</span>,<span class="hljs-string">&quot;order.msg&quot;</span>,<span class="hljs-string">&quot;订单信息：id=1,time=2019年8月17日16:41:47&quot;</span>);<br><br><br>        <span class="hljs-comment">/*//2.打印倒计时10秒</span><br><span class="hljs-comment">        for (int i = 10; i &gt; 0 ; i--) &#123;</span><br><span class="hljs-comment">            System.out.println(i+&quot;...&quot;);</span><br><span class="hljs-comment">            Thread.sleep(1000);</span><br><span class="hljs-comment">        &#125;*/</span><br><br><br>    &#125;<br></code></pre></td></tr></table></figure>

<p>消费者</p>
<p><code>src/main/resources/spring-rabbitmq-consumer.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener-container</span> <span class="hljs-attr">connection-factory</span>=<span class="hljs-string">&quot;connectionFactory&quot;</span> <span class="hljs-attr">acknowledge</span>=<span class="hljs-string">&quot;manual&quot;</span> <span class="hljs-attr">prefetch</span>=<span class="hljs-string">&quot;1&quot;</span> &gt;</span><br>    <span class="hljs-comment">&lt;!--延迟队列效果实现：  一定要监听的是 死信队列！！！--&gt;</span>    <br>    	<span class="hljs-tag">&lt;<span class="hljs-name">rabbit:listener</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;orderListener&quot;</span> <span class="hljs-attr">queue-names</span>=<span class="hljs-string">&quot;order_queue_dlx&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:listener</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">rabbit:listener-container</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><code>src/main/java/com/itheima/listener/OrderListener.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ChannelAwareMessageListener</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message, Channel channel)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">long</span> deliveryTag = message.getMessageProperties().getDeliveryTag();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//1.接收转换消息</span><br>            System.out.println(<span class="hljs-keyword">new</span> String(message.getBody()));<br><br>            <span class="hljs-comment">//2. 处理业务逻辑</span><br>            System.out.println(<span class="hljs-string">&quot;处理业务逻辑...&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;根据订单id查询其状态...&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;判断状态是否为支付成功&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;取消订单，回滚库存....&quot;</span>);<br>            <span class="hljs-comment">//3. 手动签收</span><br>            channel.basicAck(deliveryTag,<span class="hljs-keyword">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">//e.printStackTrace();</span><br>            System.out.println(<span class="hljs-string">&quot;出现异常，拒绝接受&quot;</span>);<br>            <span class="hljs-comment">//4.拒绝签收，不重回队列 requeue=false</span><br>            channel.basicNack(deliveryTag,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="日志与监控"><a href="#日志与监控" class="headerlink" title="日志与监控"></a>日志与监控</h2><h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><ul>
<li><p>RabbitMQ默认日志存放路径： /var/log/rabbitmq/rabbit@xxx.log</p>
</li>
<li><p>日志包含了RabbitMQ的版本号、Erlang的版本号、RabbitMQ服务节点名称、cookie的hash值、RabbitMQ配置文件地址、内存限制、磁盘限制、默认账户guest的创建以及权限配置等等</p>
</li>
</ul>
<h3 id="rabbitmqctl管理和监控"><a href="#rabbitmqctl管理和监控" class="headerlink" title="rabbitmqctl管理和监控"></a>rabbitmqctl管理和监控</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell">查看如何使用<br><span class="hljs-meta">#</span><span class="bash"> rabbitmqctl <span class="hljs-built_in">help</span></span><br><br>查看队列<br><span class="hljs-meta">#</span><span class="bash"> rabbitmqctl list_queues</span><br><br>查看exchanges<br><span class="hljs-meta">#</span><span class="bash"> rabbitmqctl list_exchanges</span><br><br>查看用户<br><span class="hljs-meta">#</span><span class="bash"> rabbitmqctl list_users</span><br><br>查看连接<br><span class="hljs-meta">#</span><span class="bash"> rabbitmqctl list_connections</span><br><br>查看消费者信息<br><span class="hljs-meta">#</span><span class="bash"> rabbitmqctl list_consumers</span><br><br>查看环境变量<br><span class="hljs-meta">#</span><span class="bash"> rabbitmqctl environment</span><br><br>查看未被确认的队列<br><span class="hljs-meta">#</span><span class="bash"> rabbitmqctl list_queues  name messages_unacknowledged</span><br><br>查看单个队列的内存使用<br><span class="hljs-meta">#</span><span class="bash"> rabbitmqctl list_queues name memory</span><br><br>查看准备就绪的队列<br><span class="hljs-meta">#</span><span class="bash"> rabbitmqctl list_queues name messages_ready</span><br><br></code></pre></td></tr></table></figure>



<h2 id="消息可靠性分析与追踪"><a href="#消息可靠性分析与追踪" class="headerlink" title="消息可靠性分析与追踪"></a>消息可靠性分析与追踪</h2><ul>
<li><p>在使用任何消息中间件的过程中，难免会出现某条消息异常丢失的情况。对于RabbitMQ而言，可能是因为生产者或消费者与RabbitMQ断开了连接，而它们与RabbitMQ又采用了不同的确认机制；也有可能是因为交换器与队列之间不同的转发策略；甚至是交换器并没有与任何队列进行绑定，生产者又不感知或者没有采取相应的措施；另外RabbitMQ本身的集群策略也可能导致消息的丢失。这个时候就需要有一个较好的机制跟踪记录消息的投递过程，以此协助开发和运维人员进行问题的定位。</p>
</li>
<li><p>在RabbitMQ中可以使用Firehose和rabbitmq_tracing插件功能来实现消息追踪。</p>
</li>
</ul>
<h3 id="消息追踪-Firehose"><a href="#消息追踪-Firehose" class="headerlink" title="消息追踪-Firehose"></a>消息追踪-Firehose</h3><ul>
<li>firehose的机制是将生产者投递给rabbitmq的消息，rabbitmq投递给消费者的消息按照指定的格式发送到默认的exchange上。这个默认的exchange的名称为amq.rabbitmq.trace，它是一个topic类型的exchange。发送到这个exchange上的消息的routing key为 publish.exchangename 和 deliver.queuename。其中exchangename和queuename为实际exchange和queue的名称，分别对应生产者投递到exchange的消息，和消费者从queue上获取的消息。</li>
</ul>
<p>注意：打开 trace 会影响消息写入功能，适当打开后请关闭。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">rabbitmqctl trace_on：<br><span class="hljs-meta">#</span><span class="bash"> 开启Firehose命令</span><br><br>rabbitmqctl trace_off：<br><span class="hljs-meta">#</span><span class="bash">关闭Firehose命令</span><br></code></pre></td></tr></table></figure>

<h3 id="消息追踪-rabbitmq-tracing插件"><a href="#消息追踪-rabbitmq-tracing插件" class="headerlink" title="消息追踪-rabbitmq_tracing插件"></a>消息追踪-rabbitmq_tracing插件</h3><p>使用rabbitmq_tracing插件功能来实现消息追踪</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">rabbitmq-plugins enable rabbitmq_tracing<br><span class="hljs-meta">#</span><span class="bash"> 开启插件</span><br></code></pre></td></tr></table></figure>



<h1 id="RabbitMQ-应用问题"><a href="#RabbitMQ-应用问题" class="headerlink" title="RabbitMQ 应用问题"></a>RabbitMQ 应用问题</h1><h2 id="消息可靠性保障"><a href="#消息可靠性保障" class="headerlink" title="消息可靠性保障"></a>消息可靠性保障</h2><p><strong>消息补偿机制</strong></p>
<p>需求：100%确保消息发送成功</p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224235411180.png" srcset="/img/loading.gif" alt="image-20210224235411180"></p>
<h2 id="消息幂等性保障"><a href="#消息幂等性保障" class="headerlink" title="消息幂等性保障"></a>消息幂等性保障</h2><ul>
<li><p>幂等性指一次和多次请求某一个资源，对于资源本身应该具有同样的结果。也就是说，其任意多次执行对资源本身所产生的影响均与一次执行的影响相同。</p>
</li>
<li><p>在MQ中指，消费多条相同的消息，得到与消费该消息一次相同的结果。</p>
</li>
</ul>
<p><strong>乐观锁解决方案</strong></p>
<p><img src="/2021/02/22/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210224235547502.png" srcset="/img/loading.gif" alt="image-20210224235547502"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%9C%AA%E5%BD%92%E6%A1%A3/">未归档</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/02/22/MQ%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E4%BB%8B%E7%BB%8D/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">MQ消息队列中间件的介绍</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/02/20/Redis%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4%EF%BC%88Windows%E3%80%81Linux%EF%BC%89/">
                        <span class="hidden-mobile">Redis安装步骤（Windows、Linux）</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://mccontinuing.github.io/" target="_blank" rel="nofollow noopener"><span>Mccontinuing</span></a> <i class="iconfont icon-love"></i> <a href="http://http://qufang.xyz/" target="_blank" rel="nofollow noopener"><span>SGLMYD</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
